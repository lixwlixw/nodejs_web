<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>dataHub-搜索</title>
<link rel="stylesheet" href="css/bootstrap.min.css">
<link rel="stylesheet" href="css/command.css">
<link rel="stylesheet" href="css/loader.css">
<link rel="stylesheet" href="css/animate.css">
<link rel="stylesheet" href="css/search.css">
<link rel="stylesheet" href="css/pagination.css"/>
</head>

<style>
	.nav > li > a:hover{
		background-color:rgba(31,154,218,0.7); 
	}	
	.navbar-toggle .icon-bar {
	    background-color: #fff;
	}
	.navbar-nav > li > a:focus{
		background:none;
	}
	.pagination a,.pagination span{
		display: inline;
		float: none;
	}
	.pagination a, .pagination span{
		padding:0.5em 1em;
	}
	.pagination a{
		border:1px solid #e5e5e5;
		color: #666;
		border-radius: 3px;
	}
	.pagination span.current{
		border-radius: 3px;
		background: #29abe2;
	}
	.pagination{
		float: right;
	}
</style>

<body style="background-color: #f5f5f5;">


	<!-- loading -->
	<div class="be-loader" style="display: block;">
	   	<div class="spinner">
			<div class="spinner-container container1">
				<div class="circle1"></div>
			    <div class="circle2"></div>
			    <div class="circle3"></div>
			    <div class="circle4"></div>
			</div>
		  	<div class="spinner-container container2">
			    <div class="circle1"></div>
			    <div class="circle2"></div>
			    <div class="circle3"></div>
			    <div class="circle4"></div>
		  	</div>
		  	<div class="spinner-container container3">
			    <div class="circle1"></div>
			    <div class="circle2"></div>
			    <div class="circle3"></div>
			    <div class="circle4"></div>
			</div>
		</div>
	</div>
	
	
	<!-- 头部导航 -->
	<header></header>
	
	<!-- 内容页 -->
	<div class="container" style='padding:0px;margin-top:50px;'>
	
			<div class="col-md-12 col-sm-12" id="lComs" style="padding: 20px 0px">
							
				<div id="terminal-content-head"><b>为您找到相关结果</b><b id="ttnum" style="color: #0077aa;"></b>个</div>
	
				<div id="terminal-content-body"></div>
				
				<div class="pages"></div>	
				
			</div>
						
	</div>
		
	<!-- 尾部 -->
	<footer></footer>
	
	<div id="loginTem"></div>

</body>
<!-- 
<script src="http://apps.bdimg.com/libs/jquery/1.9.1/jquery.min.js"></script>
 -->
 <script src="js/jquery.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/jquery.cookie.js"></script>
<script src="js/ngUrl.js"></script>
<script src="js/login.js"></script>
<script src="js/base64.js"></script>
<script src="js/md5.js"></script>
<script src="js/jquery.pagination.js"></script>
<script>

	$("a").focus(function(){this.blur()});
	$("header").load("common/header.html");
	$("footer").load("common/footer.html");
	$("#loginTem").load("common/login.html");

	
	var rtext='';
    var itemid = /\?.*rtext=([^&]*).*$/;
    if (itemid.test(decodeURIComponent(window.location.href))) {
    	rtext = itemid.exec(decodeURIComponent(window.location.href))[1];
   	}
    
    var data={};
	if(rtext!=""){
		data={"text":rtext};
	}

	
	$(window).load(function(){		
		$(".be-loader").fadeOut("slow");
	});

	
</script>

<script>
	var repos=[];
	var totals=0;
	$(window).load(function(){
		$(".be-loader").fadeOut("slow");
	});

	$(document).ready(function(){
		
		getrepname(1);
		ajaxRe();
	    $(".pages").pagination(totals, {
	        items_per_page: 5,
	        num_display_entries: 1,
	        num_edge_entries: 5 ,
	        prev_text:"上一页",
	        next_text:"下一页",
	        ellipse_text:"...",
//	      num_edge_entries:1,
	        link_to:"javascript:void(0)",
	        callback:fenS,
	        load_first_page:false
	    });
	});
	
	function rel(str){
		var s="";
		if(str.indexOf(rtext)!=-1){
			s=str.replace(rtext, "<span style=background-color:#fffe8f;>"+rtext+"</span>"); 
		}else{
			s=str;
		}
		return s;
	}
	
    function getrepname(pages) {

        $.ajax({
			url: ngUrl+"/search?size=5&page="+pages,
    		type: "get",
    		cache:false,
    		data:data,
    	   	async:false,
    		dataType:'json',
    		success:function(json){  	    			
    			if(json.data.length!=0){
    				var pages=json.data.results.length;
    				totals=json.data.total;
    				$("#ttnum").text(totals);
    				for(var i=0;i<pages;i++){
    					repos.push([json.data.results[i].repname,json.data.results[i].itemname]);			
    				}
    			}else{
    				console.log("报错");  			
    			}	    		
    		},
    		error:function(json){
    			alert("程序出错，请稍后重试");
    		}
    	});
    }
    
    
    

    
    function fenS(new_page_index, pagination_container){

    		$("#terminal-content-body").empty();
        	repos=[];
        	getrepname(new_page_index+1);
        	ajaxRe();
	
    }
    
	
	
	function ajaxRe(){
		
		
		//返回该DataItem的订阅量
        var dataitemd = [];
        for(var i= 0;i<repos.length;i++) {
            $.ajax({
                url: ngUrl + "/subscription_stat/" +repos[i][0],
                cache: false,
                async: false,
                success: function (msg) {
                    dataitemd.push(msg.data.numsubs);
                }
            });
        }
        //返回该DataItem的pull量
        var dataitemdpullNum = [];
        for(var i= 0;i<repos.length;i++) {
            $.ajax({
                url: ngUrl + "/transaction_stat/" +repos[i][0]+repos[i][1],
                cache: false,
                async: false,
                success: function (msg) {
                    dataitemdpullNum.push(msg.data.numpulls);
                }
            });
        }
        
	      //返回该DataItem的star量
        var dataitemdstarNum = [];
        for(var i= 0;i<repos.length;i++) {
            $.ajax({
                url: ngUrl + "/star_stat/" +repos[i][0]+repos[i][1],
                cache: false,
                async: false,
                success: function (msg) {
                	dataitemdstarNum.push(msg.data.numstars);
                }
            });
        }
		
		if(repos.length!=0){
			for(var i=0;i<repos.length;i++){
				$.ajax({
					url: ngUrl+"/repositories/"+repos[i][0]+"/"+repos[i][1],
		    		type: "get",
		    		cache:false,
		    	   	async:false,
		    	   	data:data,
		    		dataType:'json',
		    		success:function(json){ 
		    			$("#loading").empty();
	    					var vvclass="";
	    					var label=json.data.label.sys.supply_style;
	    					var labelV="";
	    					if(label=="single"||label=="api"){
		    					vvclass="api";
		    					//labelV="实时单条";
		    					labelV="API";
		    				}
		    				if(label=="batch"){
		    					vvclass="period";
		    					labelV="批量数据";
		    				}
		    				if(label=="flow"){
		    					vvclass="flot-data";
		    					labelV="流式数据";
		    				}
		    				
		    				/* var times=json.data.optime;
		    				var jdTime="";
		    				var xdTime="";
		    				var showTime="";
		    				var nums=times.indexOf("|");
		    				if(nums!="-1"){
		    					jdTime=times.substring(0,nums+1);
		    					xdTime=times.substring(nums+1,times.length);
		    					showTime=xdTime;
		    				}else{
		    					showTime=times;
		    				} */
		    				var times=json.data.optime;
		    				var jdTime=times.substring(0, times.indexOf("."));
		    				var xdTime="";
		    				var showTime="";
		    				var nums=times.indexOf("|");
		    				if(nums!="-1"){
		    					showTime=times.substring(times.indexOf("|")+1,times.length);
		    				}else{
		    					showTime=times.substring(0, times.indexOf("."));
		    				} 
		    				
		    				var realname="";
		    				//该用户昵称
		    				$.ajax({
		    					url: ngUrl+"/users/"+json.data.create_user,
		    					type: "get",
		    					cache:false,
		    					data:{},
		    					async:false,
		    					dataType:'json',
		    					success:function(json){
		    						if(json.code == 0){
		    							realname=json.data.userName;
		    						}else {
		    							console.log("报错");
		    						}
		    					},
		    					error:function(json){
		    						alert("程序出错，请稍后重试");
		    					}
		    				});		    					
		    				
	    					$("#terminal-content-body").append(""+
			    					"<div class='selectBody' style='background:#fff;float:left;margin-bottom:30px;'>"+
										"<div class='repo-head'>"+
											"<div class='tab-head-div'><a style='color:#0077aa' target='_blank' href='itemDetails.html?repname="+repos[i][0]+"&itemname="+repos[i][1]+"'>"+rel(repos[i][0])+"&nbsp;&nbsp;<span style='color:#000;'>/</span>&nbsp;&nbsp;"+rel(repos[i][1])+"</a></div>"+
										//	"<div class='tab-head-icon'></div>"+
											"<div class='repo-head-right'>数据拥有方：<a href='dataOfDetails.html?username="+json.data.create_user+"'>"+realname+"</a></div>"+	
										"</div>"+
										"<div class='repo-body'>"+
											"<div id='repo-text'>"+rel(json.data.comment)+"</div>"+
											"<div class='repo-body-tail'>"+
												"<div class='repo-body-tail-left'>"+
													"<div class='updatetime-icon' title='更新时间'></div>"+
													"<div class='updatetime-value' title="+jdTime+">"+showTime+"</div>"+
													"<div class='tag-icon' title='tag数量'></div>"+
													"<div class='tag-value'>"+json.data.tags+"</div>"+
												"</div>"+
												"<div class='repo-body-tail-mid'>"+
													"<div class="+vvclass+">"+labelV+"</div>"+
			    								"</div>"+
												"<div class='repo-body-tail-right'>"+
													"<div class='shwr'>"+
													"<div class='star-icon' title='star量'></div>"+
													"<div class='star-value'>"+dataitemdstarNum[i]+"</div>"+
													"<div class='subscript-icon' title='订阅量'></div>"+
    				                                "<div class='subscript-value'>"+dataitemd[i]+"</div>"+
    				                                "<div class='downloaded-icon' title='pull量'></div>"+
    				                                "<div class='downloaded-value'>"+dataitemdpullNum[i]+"</div>"+
			    				                    "</div>"+
												"</div>"+
											"</div>"+
										"</div>"+
									"</div>"
			    				);	    		
		    		},
		    		error:function(json){
		    			alert("程序出错，请稍后重试");
		    		}
	    		}); 
			}
		}else{
			$("#loading").empty();
			$("#terminal-content-body").append("<div class='repo-body'><p class='text-center'>暂无搜索相关数据</p></div>");
		}

		
	}
	
	
	
	
	
	
	
	
	
	
</script>




</html>
